@inherits LayoutComponentBase
@using CoopQueue.Client.Services
@inject IAuthService AuthService
@inject NavigationManager NavManager
@inject AuthenticationStateProvider AuthStateProvider

@* Global Providers required by MudBlazor components. 
   MudThemeProvider handles the Light/Dark mode switching logic.
*@
<MudThemeProvider @bind-IsDarkMode="@_isDarkMode" Theme="@_theme" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1" Class="appbar-gradient">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" 
                       Color="Color.Inherit" 
                       Edge="Edge.Start" 
                       OnClick="@((e) => DrawerToggle())" />
        <MudText Typo="Typo.h5" Class="ml-3">CoopQueue</MudText>

        <MudSpacer />

        @* Theme Toggle Button *@
        <MudTooltip Text="Toggle Theme">
            <MudIconButton Icon="@(_isDarkMode? Icons.Material.Filled.WbSunny : Icons.Material.Filled.DarkMode)"
                           Color="Color.Inherit"
                           OnClick="@ToggleDarkMode" />
        </MudTooltip>

        @* User Authentication Status Display *@
        <AuthorizeView>
            <Authorized>
                <MudText Class="mr-4">Hello, @context.User.Identity?.Name!</MudText>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Secondary"
                           OnClick="Logout">
                    Logout
                </MudButton>
            </Authorized>
            <NotAuthorized>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="@(() => NavManager.NavigateTo("/login"))">
                    Login
                </MudButton>
            </NotAuthorized>
        </AuthorizeView>
    </MudAppBar>

    <MudDrawer @bind-Open="_drawerOpen" 
               ClipMode="DrawerClipMode.Always" 
               Elevation="2">
        <div class="d-flex flex-column mud-height-full">

            <NavMenu />

            <MudSpacer />

            <div class="pa-4">
                <MudDivider Class="mb-3" />

                <div class="d-flex flex-column gap-1">
                    <div class="d-flex align-center">
                        <MudText Typo="Typo.caption" 
                                 Style="font-size: 0.7rem; opacity: 0.7;" 
                                 Class="mr-1">
                            Data by
                        </MudText>
                        <MudLink Href="https://www.igdb.com" 
                                 Target="_blank" 
                                 Typo="Typo.caption" 
                                 Color="Color.Primary" 
                                 Underline="Underline.Hover">
                            <b>IGDB</b>
                        </MudLink>
                    </div>

                    <div class="d-flex align-center mt-1">
                        <MudText Typo="Typo.caption" 
                                 Style="font-size: 0.7rem; opacity: 0.7;" 
                                 Class="mr-1">
                            App by
                        </MudText>
                        <MudLink Href="https://github.com/GraegelTh" 
                                 Target="_blank" 
                                 Color="Color.Inherit" 
                                 Class="d-flex align-center" 
                                 Underline="Underline.None">
                            <MudIcon Icon="@Icons.Custom.Brands.GitHub" 
                                     Size="Size.Small" 
                                     Class="mr-1" 
                                     Style="font-size: 0.9rem;" />                            
                        </MudLink>
                    </div>
                </div>
            </div>

        </div>


    </MudDrawer>

    <MudMainContent Class="d-flex flex-column">
        <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
            @Body
        </MudContainer>       

    </MudMainContent>
    
</MudLayout>

@code {
    bool _drawerOpen = true;

    
    bool _isDarkMode = true;

    // Custom Color Palette Configuration
    private MudTheme _theme = new MudTheme()
    {
        PaletteLight = new PaletteLight()
        {
            Primary = Colors.DeepPurple.Default,
            Secondary = Colors.Pink.Accent2,
            AppbarBackground = Colors.DeepPurple.Default,
            Background = "#F4F6F8",
            Surface = "#FFFFFF"
        },
        PaletteDark = new PaletteDark()
        {
            Primary = Colors.DeepPurple.Lighten1,

            Secondary = Colors.Pink.Accent1,

            
            AppbarBackground = Colors.DeepPurple.Darken3,

            
            Background = Colors.Gray.Darken4,

            
            Surface = Colors.Gray.Darken3,
        }
    };

    /// <summary>
    /// Lifecycle hook triggered when the MainLayout component is initialized.
    /// Used to validate the JWT token on app startup to prevent stale authentication states.
    /// </summary>
    protected override async Task OnInitializedAsync()
    {
        await CheckTokenValidity();
    }

    /// <summary>
    /// Validates if the current user's JWT token is still valid.
    /// If the token is expired or corrupted, the user is automatically logged out
    /// and redirected to the login page to avoid confusing authorization errors.
    /// </summary>
    private async Task CheckTokenValidity()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();

        
        if (state.User.Identity?.IsAuthenticated == true)
        {
            var isValid = await AuthService.IsTokenValid();

            if (!isValid)
            {
                NavManager.NavigateTo("/login");
            }
        }
    }

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    void ToggleDarkMode()
    {
        _isDarkMode = !_isDarkMode;
    }

    private async Task Logout()
    {
        await AuthService.Logout();
        NavManager.NavigateTo("/login");
    }
}